name: Deploy Backend to Digital Ocean

on:
    push:
        branches:
            - main
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: üöÄ Deploy to Digital Ocean
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.DO_HOST }}
                  username: ${{ secrets.DO_USERNAME }}
                  key: ${{ secrets.DO_SSH_KEY }}
                  passphrase: ${{ secrets.DO_SSH_PASSPHRASE }}
                  script: |
                      cd ~/ai-cruel-backend-updated
                      echo "üì• Pulling latest code..."
                      git pull origin main

                      echo "üõë Stopping old processes..."
                      pkill -f 'python3 simple_email_reminder.py' || true
                      pkill -f uvicorn || true
                      sleep 2

                      echo "ÔøΩ Starting email reminder..."
                      nohup python3 simple_email_reminder.py > email_reminders.log 2>&1 &

                      echo "üöÄ Starting backend..."
                      nohup uvicorn main:app --host 0.0.0.0 --port 8000 > backend.log 2>&1 &

                      sleep 3
                      echo "‚úÖ Deployment complete!"
                      ps aux | grep -E 'uvicorn|simple_email' | grep -v grep

            - name: üè• Health Check
              run: |
                  sleep 5
                  response=$(curl -s http://${{ secrets.DO_HOST }}:8000/health)
                  echo "Response: $response"
                  if echo "$response" | grep -q "healthy"; then
                    echo "‚úÖ Backend is healthy!"
                  else
                    echo "‚ùå Backend health check failed!"
                    exit 1
                  fi
