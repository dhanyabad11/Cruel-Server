name: Deploy to Digital Ocean

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to Digital Ocean
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          password: ${{ secrets.DO_PASSWORD }}
          script: |
            cd ~/ai-cruel-backend-updated
            git pull origin main
            pkill -f 'python3 simple_email_reminder.py' || true
            pkill -f uvicorn || true
            sleep 2
            nohup python3 simple_email_reminder.py > email_reminders.log 2>&1 &
            nohup uvicorn main:app --host 0.0.0.0 --port 8000 > backend.log 2>&1 &
            sleep 3
            echo "âœ… Deployment complete!"
            ps aux | grep -E 'uvicorn|simple_email' | grep -v grep
